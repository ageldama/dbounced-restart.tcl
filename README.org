#+TITLE: throttled-restart.tcl
#+AUTHOR: jonghyouk yun <ageldama@gmail.com>


1. Start a command as its subprocess.
1. Kill its subprocess and Restart on STDIN.
   1. can specify "Kill command".
   1. combined via pipe with tools like [[https://github.com/emcrisostomo/fswatch][fswatch]], [[https://github.com/inotify-tools/inotify-tools][inotify-tools]].
1. Ignore consequent inputs ("debouncing")


* SYNOPSIS

** Triggered by raw STDIN
   #+begin_src shell
     $ ./throttled-restart.tcl -c ./examples/echosrv.tcl
     [2825/09/24 13:55:19] [./throttled-restart.tcl] [start_proc] [info] STARTING: ./examples/echosrv.tcl ...
     [2825/09/24 13:55:20] [./throttled-restart.tcl::tid0x245d1e43808] [run_cmd] [info] STARTED-PID: 6215
     Listen on 127.0.0.1:1818 ...

     [2825/09/24 13:55:22] [./throttled-restart.tcl] [handle_input] [info] --- GOT NEW INPUT ---
     [2825/09/24 13:55:22] [./throttled-restart.tcl] [handle_input] [info] IGNORED: 2 seconds left ...

     [2825/09/24 13:55:23] [./throttled-restart.tcl] [handle_input] [info] --- GOT NEW INPUT ---
     [2825/09/24 13:55:23] [./throttled-restart.tcl] [handle_input] [info] IGNORED: 1 seconds left ...

     [2825/09/24 13:55:24] [./throttled-restart.tcl] [handle_input] [info] --- GOT NEW INPUT ---
     [2825/09/24 13:55:24] [./throttled-restart.tcl] [handle_input] [info] IGNORED: 0 seconds left ...

     [2825/09/24 13:55:25] [./throttled-restart.tcl] [handle_input] [info] --- GOT NEW INPUT ---
     [2825/09/24 13:55:25] [./throttled-restart.tcl] [restart_proc] [warn] --- NO KILL-COMMAND SPECIFIED ---
     [2825/09/24 13:55:25] [./throttled-restart.tcl::tid0x245d1e43808] [kill_proc] [info] KILL-PID: 6215
     [2825/09/24 13:55:25] [./throttled-restart.tcl] [start_proc] [info] STARTING: ./examples/echosrv.tcl ...
     [2825/09/24 13:55:25] [./throttled-restart.tcl::tid0x245d1e4a808] [run_cmd] [info] STARTED-PID: 6217
     Listen on 127.0.0.1:1818 ...
     ^C
   #+end_src


** Triggered by ~fswatch~
   #+begin_src shell
     $ fswatch -Lr ~/w/ | ./throttled-restart.tcl -c ./examples/echosrv.tcl
     [2825/09/24 13:57:32] [./throttled-restart.tcl] [start_proc] [info] STARTING: ./examples/echosrv.tcl ...
     [2825/09/24 13:57:32] [./throttled-restart.tcl::tid0x2f8532843808] [run_cmd] [info] STARTED-PID: 6422
     Listen on 127.0.0.1:1818 ...
     [2825/09/24 13:57:40] [./throttled-restart.tcl] [handle_input] [info] --- GOT NEW INPUT ---
     [2825/09/24 13:57:40] [./throttled-restart.tcl] [restart_proc] [warn] --- NO KILL-COMMAND SPECIFIED ---
     [2825/09/24 13:57:40] [./throttled-restart.tcl::tid0x2f8532843808] [kill_proc] [info] KILL-PID: 6422
     [2825/09/24 13:57:40] [./throttled-restart.tcl] [start_proc] [info] STARTING: ./examples/echosrv.tcl ...
     [2825/09/24 13:57:40] [./throttled-restart.tcl] [handle_input] [info] --- GOT NEW INPUT ---
     [2825/09/24 13:57:40] [./throttled-restart.tcl] [handle_input] [info] IGNORED: 5 seconds left ...
     [2825/09/24 13:57:40] [./throttled-restart.tcl] [handle_input] [info] --- GOT NEW INPUT ---
     [2825/09/24 13:57:40] [./throttled-restart.tcl] [handle_input] [info] IGNORED: 5 seconds left ...
     [2825/09/24 13:57:40] [./throttled-restart.tcl] [handle_input] [info] --- GOT NEW INPUT ---
     [2825/09/24 13:57:40] [./throttled-restart.tcl] [handle_input] [info] IGNORED: 5 seconds left ...
     [2825/09/24 13:57:41] [./throttled-restart.tcl::tid0x2f853284a808] [run_cmd] [info] STARTED-PID: 6478
     Listen on 127.0.0.1:1818 ...
     ^C
   #+end_src


* OPTIONS
  #+begin_src shell
        ./throttled-restart.tcl [options]

    OPTIONS:
     -c value             command to start process <>
     -k value             command to kill process <>
     -i value             throttling seconds (0 = no-throttling) <5>
     -v                   (more) verbose output
     --                   Forcibly stop option processing
     -help                Print this message
     -?                   Print this message
  #+end_src



* REQUIREMENTS

  1. [[https://www.tcl-lang.org/][Tcl]] 8.6+
  1. [[https://www.tcl-lang.org/man/tcl8.6/ThreadCmd/thread.htm][Tcl Thread]] 2.8.10+
  1. [[https://www.tcl-lang.org/software/tcllib/][Tcllib]] 2.0+

